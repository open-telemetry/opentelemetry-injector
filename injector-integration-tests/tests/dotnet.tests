# Copyright The OpenTelemetry Authors
# SPDX-License-Identifier: Apache-2.0

run_test_case \
  "sets CORECLR_PROFILER_PATH" \
  "app" \
  "./dotnetapp coreclr-profiler-path" \
  "CORECLR_PROFILER_PATH: /usr/lib/opentelemetry/dotnet/${LIBC_FLAVOR}/${DOTNET_ARCH}/OpenTelemetry.AutoInstrumentation.Native.so"

# For test cases with the "default configuration file" substring in their label, run-tests-within-container.sh
# will provide a configuration file in the default location (/etc/opentelemetry/otelinject.conf).
run_test_case \
  "uses CORECLR_PROFILER_PATH path from the default configuration file" \
  "app" \
  "./dotnetapp coreclr-profiler-path" \
  "CORECLR_PROFILER_PATH: /path/from/config-file/dotnet/${LIBC_FLAVOR}/${DOTNET_ARCH}/OpenTelemetry.AutoInstrumentation.Native.so"
run_test_case \
  "the DOTNET_AUTO_INSTRUMENTATION_AGENT_PATH_PREFIX environment variable overrides the path prefix from the default configuration file" \
  "app" \
  "./dotnetapp coreclr-profiler-path" \
  "CORECLR_PROFILER_PATH: /path/from/environment-variable/dotnet/${LIBC_FLAVOR}/${DOTNET_ARCH}/OpenTelemetry.AutoInstrumentation.Native.so" \
  "DOTNET_AUTO_INSTRUMENTATION_AGENT_PATH_PREFIX=/path/from/environment-variable/dotnet"

run_test_case \
  "uses DOTNET_AUTO_INSTRUMENTATION_AGENT_PATH_PREFIX path from the configuration file at a custom location" \
  "app" \
  "./dotnetapp coreclr-profiler-path" \
  "CORECLR_PROFILER_PATH: /path/from/config-file-custom-location/dotnet/${LIBC_FLAVOR}/${DOTNET_ARCH}/OpenTelemetry.AutoInstrumentation.Native.so" \
  "OTEL_INJECTOR_CONFIG_FILE=/custom/config/path/otelinject.conf"
run_test_case \
  "the DOTNET_AUTO_INSTRUMENTATION_AGENT_PATH_PREFIX environment variable overrides the path prefix from the configuration file at a custom location" \
  "app" \
  "./dotnetapp coreclr-profiler-path" \
  "CORECLR_PROFILER_PATH: /path/from/environment-variable/dotnet/${LIBC_FLAVOR}/${DOTNET_ARCH}/OpenTelemetry.AutoInstrumentation.Native.so" \
  "OTEL_INJECTOR_CONFIG_FILE=/custom/config/path/otelinject.conf DOTNET_AUTO_INSTRUMENTATION_AGENT_PATH_PREFIX=/path/from/environment-variable/dotnet"

run_test_case \
  "setting DOTNET_AUTO_INSTRUMENTATION_AGENT_PATH_PREFIX to the empty string disables setting CORECLR_PROFILER_PATH" \
  "app" \
  "./dotnetapp coreclr-profiler-path" \
  "CORECLR_PROFILER_PATH: -" \
  "DOTNET_AUTO_INSTRUMENTATION_AGENT_PATH_PREFIX="

run_test_case \
  "sets k8s.pod.uid and k8s.container.name via OTEL_RESOURCE_ATTRIBUTES" \
  "app" \
  "./dotnetapp otel-resource-attributes" \
  "OTEL_RESOURCE_ATTRIBUTES: k8s.namespace.name=my-namespace,k8s.pod.name=my-pod,k8s.pod.uid=275ecb36-5aa8-4c2a-9c47-d8bb681b9aff,k8s.container.name=test-app"

run_test_case \
  "adds the .NET profiler" \
  "app" \
  "./dotnetapp verify-startup-hook-has-been-injected" \
  "otel_injector_dotnet_no_op_startup_hook_has_been_loaded: true"

# For test cases with the "default configuration file" substring in their label, run-tests-within-container.sh
# will provide a configuration file in the expected location (/etc/opentelemetry/otelinject.conf).
run_test_case \
  "uses the .NET profiler path from the default configuration file" \
  "app" \
  "./dotnetapp verify-startup-hook-has-been-injected" \
  "otel_injector_dotnet_no_op_startup_hook_has_been_loaded: true"
run_test_case \
  "the DOTNET_AUTO_INSTRUMENTATION_AGENT_PATH_PREFIX environment variable overrides .NET profiler path from the default configuration file" \
  "app" \
  "./dotnetapp verify-startup-hook-has-been-injected" \
  "otel_injector_dotnet_no_op_startup_hook_has_been_loaded: true" \
  "DOTNET_AUTO_INSTRUMENTATION_AGENT_PATH_PREFIX=/path/from/environment-variable/dotnet"

run_test_case \
  "setting DOTNET_AUTO_INSTRUMENTATION_AGENT_PATH_PREFIX to the empty string will result in the .NET auto-instrumentation not being loaded" \
  "app" \
  "./dotnetapp verify-startup-hook-has-been-injected" \
  "otel_injector_dotnet_no_op_startup_hook_has_been_loaded: -" \
  "DOTNET_AUTO_INSTRUMENTATION_AGENT_PATH_PREFIX="

run_test_case \
  "OTEL_ custom env var is returned according to the env file provided" \
  "app" \
  "./dotnetapp custom-env-var OTEL_SDK_DISABLED" \
  "OTEL_SDK_DISABLED: true"

run_test_case \
  "non OTEL_ custom env var is ignored" \
  "app" \
  "./dotnetapp  custom-env-var CUSTOM_ENV_VAR" \
  "CUSTOM_ENV_VAR: -"

run_test_case \
  "setting OTEL_INJECTOR_DISABLED to true string disables setting CORECLR_PROFILER_PATH" \
  "app" \
  "./dotnetapp coreclr-profiler-path" \
  "CORECLR_PROFILER_PATH: -" \
  "OTEL_INJECTOR_DISABLED=1"
