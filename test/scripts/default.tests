# Copyright The OpenTelemetry Authors
# SPDX-License-Identifier: Apache-2.0

# Note: The default test cases are run via the Node.js runtime. Node.js specific test case (so everything around
# modifying NODE_OPTIONS) are in node_js.tests.

# Verify that unrelated environment variables are not accidentally modified.
run_test_case \
  "returns undefined for non-existing environment variable" \
  "app" \
  "node index.js non-existing" \
  "DOES_NOT_EXIST: -"
run_test_case \
  "returns environment variable unchanged" \
  "app" \
  "node index.js existing" \
  "TEST_VAR: value" \
  "TEST_VAR=value "

# Tests for modifying OTEL_RESOURCE_ATTRIBUTES.
run_test_case \
  "sets k8s.pod.uid and k8s.container.name via OTEL_RESOURCE_ATTRIBUTES" \
  "app" \
  "node index.js otel-resource-attributes" \
  "OTEL_RESOURCE_ATTRIBUTES: k8s.namespace.name=my-namespace,k8s.pod.name=my-pod,k8s.pod.uid=275ecb36-5aa8-4c2a-9c47-d8bb681b9aff,k8s.container.name=test-app"
run_test_case \
  "sets k8s.pod.uid and k8s.container.name via OTEL_RESOURCE_ATTRIBUTES with pre-existing value" \
  "app" \
  "node index.js otel-resource-attributes" \
  "OTEL_RESOURCE_ATTRIBUTES: k8s.namespace.name=my-namespace,k8s.pod.name=my-pod,k8s.pod.uid=275ecb36-5aa8-4c2a-9c47-d8bb681b9aff,k8s.container.name=test-app,foo=bar" \
  "OTEL_RESOURCE_ATTRIBUTES=foo=bar"
run_test_case \
  "use mapped app.kubernetes.io labels for service.name and friends" \
  "app" \
  "node index.js otel-resource-attributes" \
  "OTEL_RESOURCE_ATTRIBUTES: k8s.namespace.name=my-namespace,k8s.pod.name=my-pod,k8s.pod.uid=275ecb36-5aa8-4c2a-9c47-d8bb681b9aff,k8s.container.name=test-app,service.name=service-name,service.version=service-version,service.namespace=service-namespace" \
  "OTEL_INJECTOR_SERVICE_NAME=service-name OTEL_INJECTOR_SERVICE_VERSION=service-version OTEL_INJECTOR_SERVICE_NAMESPACE=service-namespace"
run_test_case \
  "use mapped resource.opentelemetry.io labels as additional resource attributes" \
  "app" \
  "node index.js otel-resource-attributes" \
  "OTEL_RESOURCE_ATTRIBUTES: k8s.namespace.name=my-namespace,k8s.pod.name=my-pod,k8s.pod.uid=275ecb36-5aa8-4c2a-9c47-d8bb681b9aff,k8s.container.name=test-app,aaa=bbb,ccc=ddd" \
  "OTEL_INJECTOR_RESOURCE_ATTRIBUTES=aaa=bbb,ccc=ddd"
run_test_case \
  "combine mapped app.kubernetes.io and resource.opentelemetry.io labels" \
  "app" \
  "node index.js otel-resource-attributes" \
  "OTEL_RESOURCE_ATTRIBUTES: k8s.namespace.name=my-namespace,k8s.pod.name=my-pod,k8s.pod.uid=275ecb36-5aa8-4c2a-9c47-d8bb681b9aff,k8s.container.name=test-app,service.name=service-name,service.version=service-version,service.namespace=service-namespace,aaa=bbb,ccc=ddd" \
  "OTEL_INJECTOR_SERVICE_NAME=service-name OTEL_INJECTOR_SERVICE_VERSION=service-version OTEL_INJECTOR_SERVICE_NAMESPACE=service-namespace OTEL_INJECTOR_RESOURCE_ATTRIBUTES=aaa=bbb,ccc=ddd"
